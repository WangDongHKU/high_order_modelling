---
title: "MultiStrainStan"
author: "Edwin van Leeuwen"
bibliography: assets/references.bib
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  markdown:
    wrap: 72
---
---
install.packages("tidyverse")\\
install.packages("ggplot2",dependencies=TRUE)\\
install.packages("ggpubr",dependencies=TRUE) install.packages("ggpubr",
repos = "<https://cloud.r-project.org/>", dependencies = TRUE)\\
install.packages("purrr",dependencies=TRUE)
---

```{r setup, include = F}
.libPaths("E:\\Dong\\R_library")
install.packages("remotes")
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(tidyverse)
library(ggpubr)
library(R.matlab)
library("bayesplot")
library(xlsx)
knitr::opts_chunk$set(cache = T, echo = T, message = F, warning = F,include = T)
theme_set(theme_bw())
# Colourblind friendly colours
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")
scale_colour_discrete <- function(...)
  scale_colour_manual(..., values = cbPalette)
scale_fill_discrete <- function(...)
  scale_fill_manual(..., values = cbPalette)


```




```{r fitting, dependson = c("load_data"), echo = F}
# multistrain_fit <- rstan::extract(stan_fit)

rstan::check_divergences(stan_fit)
# nuts_fit_4_summary <- summary(stan_fit, pars = c("phi0","k0","npi","lp__"))$summary
# print(nuts_fit_4_summary,scientific=FALSE,digits=2)
#save(list = ls(), file = "/home/Dong/Rstan_Globally/model_str_multi_Base/model_str_multi_Base_NB.Rdata")
library(sf)
library(ggplot2)
library(reshape2)
pred_cases <- multistrain_fit$pred_cases#[,,seq(2, 263)]
# Reshape the data
data_frame <- reshape2::melt(sqrt(1+pred_cases))
colnames(data_frame) <- c("Iteration", "Variable", "Length", "Value")
# Calculate credible intervals
credible_intervals <- data_frame %>%
  group_by(Variable, Length) %>%
  summarize(
    lower = quantile(Value, 0.025),
    upper = quantile(Value, 0.975),
    lower1 = quantile(Value, 0.25),
    upper1 = quantile(Value, 0.75),
    mean = mean(Value)#quantile(Value, 0.5)
  ) %>%
  mutate(Variable = factor(Variable))

# Prepare ILI data
data_ILI <- sqrt(1+data_lst$cases) %>% tibble::as_data_frame() %>% mutate(week = row_number())
colnames(data_ILI) <- seq_len(ncol(data_ILI))
data_ILI$id <- seq_len(nrow(data_ILI))
# data_ILI$Variable <- seq_len(nrow(data_ILI))

data_ILI_long <- reshape2::melt(data_ILI, id.vars = "id")
colnames(data_ILI_long) <- c("Length", "Variable", "Value")

# Combine credible intervals and ILI data
credible_intervals <- credible_intervals %>%
  left_join(data_ILI_long, by = c("Variable", "Length"))

custom_labeller <- function(variable, value) {
  return(c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongolia', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang'))
}

# Create the plot
plot1 <- ggplot() +
  geom_point(data = credible_intervals,aes(x = Length, y = Value), color = "black", size = 0.3) +
  geom_ribbon(data =credible_intervals,aes(x = Length,ymin = lower, ymax = upper, fill = "red"), alpha = 0.1) +
  geom_ribbon(data =credible_intervals,aes(x = Length,ymin = lower1, ymax = upper1, fill = "red"), alpha = 0.2) +
  geom_line(data =credible_intervals,aes(x = Length,y = mean, color = "red")) +
  facet_wrap(~ Variable, ncol = 8, scales = "free_y", labeller = custom_labeller) +
  labs(
    # title = "95% Credible Intervals with Observed Data",
    # subtitle = "Observed data (red points)",
    x = "Length",
    y = expression(sqrt(Incidences))
  ) +
    scale_x_continuous(breaks = c(1, 53.25, 105.5, 157.75), labels = c("2020","2021","2022","2023"))+
  # ylim(0,100)+
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "bottom"
  )
plot1

ggsave("Fitting_time_varying1.pdf", plot1, width = 19, height = 11)


```

```{R}
plot_incidence <- ggplot(data = credible_intervals, aes(x = Length, y = Value, color = Value)) +  # 将color映射到Value
    geom_point(size = 1) +
  geom_line()+
    # scale_color_gradientn(colors = rainbow(30)) +  # 使用彩虹色渐变
  scale_color_viridis_c()+
    facet_wrap(~ Variable, ncol = 8, scales = "free_y", labeller = custom_labeller) +
    labs(x = "Time", y = expression(sqrt(Incidences))) +
    scale_x_continuous(breaks = c(1, 53.25, 105.5, 165.75), labels = c("2020", "2021", "2022", "2023")) +
    theme_classic() +
    guides(color = guide_legend(title =expression(sqrt(Incidences)), order = 1)) +  # 确保图例标题和颜色映射一致
    theme(legend.position = c(0.94, 0.11))  # 设置图例位置

plot_incidence
ggsave("Figure S1_Data_plot_incidence.pdf", plot_incidence, width = 19, height = 11)
# 
# ####################################################################################################
start_date <- as.Date("2020-01-01");end_date <- as.Date(start_date + 1154);date_range <- seq(start_date, end_date, by = "day")
dailyincidence1 <- as.data.frame(dailyincidence %>% t())
dailyincidence1$Date <- date_range
# dailyincidence1$province <- provincenames
dailyincidence1long <- melt(dailyincidence1, id.vars = "Date", variable.name = "province", value.name = "Incidence")
# dailyincidence1long$Incidence[is.na(dailyincidence1long$Incidence)] <- 0

dailyincidence1long <- dailyincidence1long %>%mutate(Incidence = ifelse(is.na(Incidence), 0, Incidence))
dailyincidence1long$Incidence[dailyincidence1long$Incidence < 0] <- 0

# source("plot_Incidence_map.r")
dailyincidence1long1 <- dailyincidence1long %>%
  mutate(group = floor_date(Date, "2 months")) %>%
  group_by(province, group) %>%
  summarise(Incidence = sum(Incidence, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(group = factor(group, levels = unique(group), labels = labels))

data_list <- lapply(1:length(months), function(i) {
  province_data <- data.frame(name = province,value =dailyincidence1long1 %>% filter(group == labels[i]) %>% pull(Incidence))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>%
  mutate(value_discrete = cut(sqrt(value + 1),
                              breaks = c(0, 5, 10, 30, 50, 80, 100, Inf),
                              labels = c("0-5", "5-10", "10-30", "30-50", "50-80","80-100", ">100")))
data$Month <- factor(data$Month, levels = labels)
plot_incidence2 <- ggplot(data = data) +
    geom_sf(aes(fill = value_discrete)) +
    scale_fill_manual(values = c("grey90", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C","#FFDDC1", "#CA0020"),
                      na.value = "white") +
    theme_void() +
    facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed") +
    labs(fill = expression(sqrt(Incidences))) +
    theme(
      legend.title = element_text(size = 10),  # 调整图例标题字体大小
      legend.text = element_text(size = 10),   # 调整图例文本字体大小
      plot.title = element_text(size = 10),    # 调整标题字体大小
      legend.position = c(0.9, 0.15)
    )

plot_incidence2
ggsave("Figure S2_Data_plot_incidence_map.pdf", plot_incidence2, width = 14, height = 9)


```




```{R}
source("get_credible_intervals_data.r")
source("get_credible_intervals_data_whole.r")
C <- data_lst$C
nl <- data_lst$nl
N <- data_lst$N
part <- data_lst$part
Mobility <- array(0, dim = c(1155, 31, 31))
  for (t in 1:1155) {
    for (k in 1:31) {
        for (j in part[k]:part[k+1]-1){
            Mobility[t,k,nl[j]] = 3.09*C[j,t]/1;#N[nl[j]]
        }
    }
  }
I_states <- apply(multistrain_fit$I, c(2,3), mean) # 31*1155
E_states <- apply(multistrain_fit$E, c(2,3), mean) 

move_infection  <- array(0, dim = c(31, 31,1155))
# array(0, dim = c(500, 31, 1155))
for(country1 in 1:31) {
  for(country2 in 1:31) {
  for (day in 1:1155) {
      move_infection[country2, country1, day] <- (Mobility[day,country1,country2]*(I_states[country2,day]+E_states[country2,day]))
    }
  }
}

```

```{R, plot link centrality bimontyly heatmap}
library(gridExtra)
library(cowplot)
library(igraph)
library(ggplot2)
library(ggraph)
library(maps)
library(dplyr)
library(leiden)
library(rnaturalearth)
library(rnaturalearthdata)
move_infection <- apply(move_infection, c(1, 2, 3), as.numeric)
num_intervals <- ceiling(1155/60)
cumulative_move_infection <- array(0, dim = c(31, 31, num_intervals))
data_lst_week <- array(0, dim = c(num_intervals, 31))
# 计算每bi-monthly天的累计数据 
for (i in 1:num_intervals) {
  start_day <- ceiling((i - 1) * 60 + 1)
  end_day <- min(ceiling(i * 60), 1155)
  cumulative_move_infection[,,i] <- apply(move_infection[,,start_day:end_day], c(1, 2), sum)
  data_lst_week[i,] <- weeklydata[round(start_day/7):round(end_day/7),] %>% colSums()
}
```

```{R, plot node centrality bimontyly map}
source("plot_degree_centrality_map.R")
source("plot_eigenvector_centrality_map.R")
source("plot_page_rank_centrality_map.R")
source("plot_hub_score_centrality_map.R")
source("plot_betweenness_centrality_map.r")
# source("plot_degree_centrality_map_in.R")
# plot_degree_centrality_map_in(g)

```















```{R, plot clustering map}
labelsbimonth <- c("a. Jan-Feb 2020","b. Mar-Apr 2020","c. May-Jun 2020","d. Jul-Aug 2020","e. Sep-Oct 2020","f. Nov-Dec 2020",
            "g. Jan-Feb 2021","h. Mar-Apr 2021","i. May-Jun 2021","j. Jul-Aug 2021","k. Sep-Oct 2021","l. Nov-Dec 2021",
            "m. Jan-Feb 2022","n. Mar-Apr 2022","o. May-Jun 2022","p. Jul-Aug 2022","q. Sep-Oct 2022","r. Nov-Dec 2022","s. Jan-Feb 2023")
months <- c("a. Jan-Feb 2020","b. Mar-Apr 2020","c. May-Jun 2020","d. Jul-Aug 2020","e. Sep-Oct 2020","f. Nov-Dec 2020",
            "g. Jan-Feb 2021","h. Mar-Apr 2021","i. May-Jun 2021","j. Jul-Aug 2021","k. Sep-Oct 2021","l. Nov-Dec 2021",
            "m. Jan-Feb 2022","n. Mar-Apr 2022","o. May-Jun 2022","p. Jul-Aug 2022","q. Sep-Oct 2022","r. Nov-Dec 2022","s. Jan-Feb 2023")
# Mean_Temp <- data_lst$Mean_Temp
# Mean_Temp <- data.frame(Mean_Temp)
start_date <- as.Date("2020-01-01");end_date <- as.Date(start_date + 1154);date_range <- seq(start_date, end_date, by = "day")

C <- data_lst$C
nl <- data_lst$nl
N <- data_lst$N
part <- data_lst$part
Mobility <- array(0, dim = c(1155, 31, 31))
  for (t in 1:1155) {
    for (k in 1:31) {
        for (j in part[k]:part[k+1]-1){
            Mobility[t,k,nl[j]] = 3.09*C[j,t]/1;#N[nl[j]]
        }
    }
  }
I_states <- apply(multistrain_fit$I[seq(6001,6400),,], c(2,3), mean) # 31*1155
E_states <- apply(multistrain_fit$E[seq(6001,6400),,], c(2,3), mean) 
thetap <- multistrain_fit$thetap[seq(6001,6400,1)] # size 300*31
ap1 <- tail(multistrain_fit$rate,1000) # size 300*1
npi <- multistrain_fit$npi
NPI <- data_lst$NPI1/100

p_report <- array(0, dim = c(100, 31, 1155))
for(province in 1:31) { 
  for (nums in 1:100) {
  for (day in 1:1155) {
      p_report[nums,province,day] = thetap[nums]*(exp(ap1[nums]*NPI[province,day]))}
  }
}
p_report1 <- apply(p_report,c(2,3),mean)
move_infection  <- array(0, dim = c(31, 31,1155))
# array(0, dim = c(500, 31, 1155))
for(country1 in 1:31) {
  for(country2 in 1:31) {
  for (day in 1:1155) {
      move_infection[country2, country1, day] <- Mobility[day,country1,country2]*((1-p_report1[country2,day])*I_states[country2,day]+E_states[country2,day])
    }
  }
}

move_infection <- apply(move_infection, c(1, 2, 3), as.numeric)
num_intervals <- ceiling(1155/60)
cumulative_move_infection <- array(0, dim = c(31, 31, num_intervals))
data_lst_week <- array(0, dim = c(num_intervals, 31))
# 计算每bi-monthly天的累计数据 

breaks <- start_date + months(c(seq(0,38,by=2)))
date_groups <-cut(date_range,breaks=breaks,
                  label = labelsbimonth,
                  right = FALSE)

num_groups <- length(unique(date_groups))
move_infection <- apply(move_infection, c(1, 2, 3), as.numeric)
cumulative_move_infection <- array(0, dim = c(31, 31, num_groups))

cumuMobility <- array(0, dim = c(31, 31, num_groups))
for (k in 1:num_groups) {
  for (i in 1:31) {
     for (j in 1:31) {
          group_dates <- which(date_groups == unique(date_groups)[k])
          cumuMobility[i,j,k] = sum(Mobility[group_dates,i,j])
          group_dates <- which(date_groups == unique(date_groups)[k])
          cumulative_move_infection[i, j, k] <- sum(move_infection[i, j, group_dates], na.rm = TRUE) }
          # data_lst_week[i,k] <- sum(dailyincidence[i, group_dates], na.rm = TRUE)
   }
}

for (i in 1:19) {
  g1[[i]] <- graph_from_adjacency_matrix(matrix(cumulative_move_infection[,,i]%>% t(), nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
  g2[[i]] <- graph_from_adjacency_matrix(matrix(cumulative_move_infection[,,i] , nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
}



source("plot_cluster_Infection_network.r")
source("plot_cluster_spinglass_network.r")
# GG <- G
data_list <- lapply(1:19, function(i) {
  g <- g1[[i]]
  #   graph_from_adjacency_matrix(
  #   matrix(cumulative_move_infection[,,i] %>% t(), nrow = 31, byrow = TRUE), 
  #   mode = "directed", 
  #   weighted = TRUE
  # )
  V(g)$name <- c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongol', 'Liaoning', 
                 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 
                 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 
                 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 
                 'Xizang', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
  V(g)$lon <- c(116.4142, 117.323, 114.9042, 112.2922, 113.9448, 122.6085, 126.1923, 
                127.7615, 121.4491, 119.455, 120.0934, 117.2264, 117.9874, 115.7221, 
                118.1498, 113.614, 112.2707, 111.7088, 113.4244, 108.7881, 109.7453, 
                107.874, 102.7103, 106.8748, 101.487, 88.0924, 108.8701, 104.2861, 
                95.9956, 106.1575, 85.2401)
  V(g)$lat <- c(40.1824, 39.3054, 37.8957, 37.5777, 44.0935, 41.2956, 43.6661, 
                47.862, 31.202, 32.9711, 29.1832, 31.8257, 26.0789, 27.614, 
                36.3427, 33.882, 30.9756, 27.6104, 23.3417, 23.8298, 19.1959, 
                30.0572, 30.6171, 26.8154, 24.974, 31.6927, 35.1917, 35.7518, 
                35.7452, 37.2692, 41.1129)
a <- as_data_frame(g, what = "edges")
  
edge_list <- as_data_frame(g, what = "edges") %>%
    mutate(
      from_lon = V(g)$lon[match(from, V(g)$name)],   
      from_lat = V(g)$lat[match(from, V(g)$name)],   
      to_lon = V(g)$lon[match(to, V(g)$name)],      
      to_lat = V(g)$lat[match(to, V(g)$name)],       
      weight = E(g)$weight
    ) %>% 
    transform(Month = labelsbimonth[i]) %>%
    filter(from_lon != to_lon | from_lat != to_lat) %>%  # Filter out identical points
    arrange(desc(weight)) %>%  # Sort by weight in descending order
    slice_head(n = 100)  # Select top 100 edges
  
  V(g)$community <- cluster_optimal(g, weights = E(g)$weight)$membership
  V(g)$degree <- strength(g,mode = c("out"), weights = E(g)$weight)
  province_main_community <- data.frame(
    name = V(g)$name, 
    community = V(g)$community, 
    degree = V(g)$degree, 
    lon = V(g)$lon, 
    lat = V(g)$lat
  )
  china_map <- china_map %>% 
    full_join(province_main_community, by = "name") %>% 
    transform(Month = labelsbimonth[i])
  
  list(nodes = china_map, edges = edge_list)
})

node_data <- do.call(rbind, lapply(data_list, `[[`, "nodes"))
edge_data <- do.call(rbind, lapply(data_list, `[[`, "edges"))
# edge_data <- edge_data %>% mutate(value_e = cut(weight,  breaks = c(-Inf, 5, 10, 30, 50, 80, 100, Inf),
#                               labels = c("0-5", "5-10", "10-30", "30-50", "50-80","80-100", "100+")))

edge_data <- edge_data %>% mutate(value_e = cut(weight,breaks = c(0, 2500, 10000,40000, 90000, 160000, 250000, Inf), 
                              labels = c("0-2.5K", "2.5K-10K","10K-40K", "40K-90K", "90K-160K", "160K-250K",">250K")))

# node_data <- node_data %>% mutate(value_n = cut(weight, breaks = c(-Inf, 10, 100, 300, 500, 800, 1000,1500, Inf), 
#                               labels = c("0-10", "10-100", "100-300", "300-500", "500-800","800-1000", "1000-1500", ">1500")))

node_data <- node_data %>% mutate(degree = cut(degree,breaks = c(0, 100000, 500000, 1000000, 2000000,  3000000, Inf), 
                              labels = c("0-0.1M","0.1M-0.5M", "0.5M-1M", "1M-2M", "2M-3M",">3M")))
# node_data <- node_data %>% filter(!is.na(value_n))
node_data$Month <- factor(node_data$Month, levels = labelsbimonth)
edge_data$Month <- factor(edge_data$Month, levels = labelsbimonth)
arrow_style <- arrow(type = "closed", length = unit(0.2, "cm"), angle = 30)  # 调整箭头样式

colorcom <- rainbow(4)
plot_cluster_spinglass_bi_month <- ggplot() +
    geom_sf(data = node_data, aes(fill = community), color = "black", alpha = 0.3) +  
    scale_fill_gradientn(colours = colorcom,breaks = sort(unique(node_data$community)),labels = sort(unique(node_data$community))) +
    geom_curve(
        data = edge_data,
        aes(x = from_lon, y = from_lat, xend = to_lon, yend = to_lat, color = value_e, alpha = weight),
        curvature = 0.1, 
        arrow = arrow(length = unit(2, 'mm'), type = "open")
    ) + 
    scale_alpha_continuous(range = c(0.6, 1)) +  
    scale_color_manual(values  = c("#CDDDE5", "#A4C2D5", "#7BABCA", "#2879B0", "#2E5C8C", "red", "#CA0020")) +
    geom_point(
        data = node_data,
        aes(x = lon, y = lat, size = degree, fill = community),
        shape = 21, color = "white"
    ) +   
  scale_size_manual(values = c("0-0.1M" = 1.5, "0.1M-0.5M" = 2, "0.5M-1M" = 2.5, "1M-2M" = 3, "2M-3M" = 3.5, ">3M" = 4.5), na.translate = FALSE) +
    theme_void() +
    facet_wrap(~ Month,  ncol = 5, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(labelsbimonth), unique(data$Month)))) +
    guides(
        size = guide_legend(title = "Total\noutflow", keywidth = unit(0.01, "cm"), keyheight = unit(0.1, "cm"), order = 3, ncol = 1, override.aes = list(color = "black")),
        alpha = "none",
        color = guide_legend(title = "Directed\noutflow", keywidth = unit(0.01, "cm"), keyheight = unit(0.1, "cm"), order = 2, ncol = 1),
        fill = guide_legend(title = "Cluster", keywidth = unit(0.5, "cm"), keyheight = unit(0.4, "cm"), order = 1, ncol = 1)
    ) +
    theme(strip.background = element_rect(fill = "white", color = NA),
          strip.text.x = element_text(size = 14),
        legend.position = c(0.9,0.1), 
        legend.box = "horizontal",
       legend.title = element_text(size = 10),  # 调整图例标题字体大小
       legend.text = element_text(size = 10),   # 调整图例文本字体大小
        plot.margin = margin(-0,-3.5,-1.5,-3.5),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.5, 'cm')
    )

plot_cluster_spinglass_bi_month



ggsave("Extended Data Fig 7.pdf", plot_cluster_spinglass_bi_month, width = 15, height = 11)












```





```{R, time varying centrality 1155}
library("igraph")
library(gridExtra)
library(cowplot)
labels_y <- c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongolia', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
move_infection <- move_infection
start_date <- as.Date("2020-01-01");end_date <- as.Date(start_date + 1154);date_range <- seq(start_date, end_date, by = "day")
# g <- graph_from_adjacency_matrix(matrix(move_infection[,,40] %>% t(), nrow=31, byrow=TRUE), mode = "directed",weighted = TRUE)
# # Monthly
# degree_centrality <- array(0, dim = c(1155))
# degree_centrality_all<- array(0, dim = c(31,1155))
# 
# betweenness_centrality <- array(0, dim = c(1155))
# betweenness_centrality_all<- array(0, dim = c(31,1155))
# 
# eigenvector_centrality <- array(0, dim = c(1155))
# eigenvector_centrality_all<- array(0, dim = c(31,1155))
# 
# pagerank <- array(0, dim = c(1155))
# pagerank_all<- array(0, dim = c(31,1155))
# 
# hub_score_centrality <- array(0, dim = c(1155))
# hub_score_centrality_all<- array(0, dim = c(31,1155))
# 
# for (t1 in (1:1155)){
#     g <- graph_from_adjacency_matrix(matrix(move_infection[,,t1], nrow=31, byrow=TRUE), mode = "directed",weighted = TRUE)
#     eigenvector_centrality[t1] <- eigen_centrality(g,directed = TRUE,weights =E(g)$weight)$vector%>% which.max()
#     eigenvector_centrality_all[,t1] <- (eigen_centrality(g,directed = TRUE,weights =E(g)$weight)$vector)    
#     pagerank[t1] <- page_rank(g,directed = TRUE,weights =E(g)$weight)$vector%>% which.max()
#     pagerank_all[,t1] <- page_rank(g,directed = TRUE,weights =E(g)$weight)$vector
#     g <- graph_from_adjacency_matrix(matrix(move_infection[,,t1] %>% t(), nrow=31, byrow=TRUE), mode = "directed",weighted = TRUE)
#     degree_centrality[t1] <-  strength(g,weights =E(g)$weight)%>% which.max()
#     degree_centrality_all[,t1] <-  strength(g,weights =E(g)$weight) 
#     betweenness_centrality[t1] <- betweenness(g,directed = TRUE,weights =1/E(g)$weight)%>% which.max()
#     betweenness_centrality_all[,t1] <- betweenness(g,directed = TRUE,weights =1/E(g)$weight)
#     hub_score_centrality[t1] <- hub_score(g,weights =E(g)$weight)$vector %>% which.max()
#     hub_score_centrality_all[,t1] <- hub_score(g,weights =E(g)$weight)$vector
# }
# 
# source("Node_Degree_centrality_plot.r")
# source("Node_Eigenvector_centrality_plot.r")
# source("Node_hub_score_centrality_plot.r")
# source("Node_betweenness_centrality_plot.r")
# source("Node_pagerank_centrality_plot.r")
# 
# p_degree <- Node_Degree_centrality_plot(degree_centrality_all, labels_y, 3)
# p_eigen <- Node_Eigenvector_centrality_plot(eigenvector_centrality_all, labels_y, 3)
# p_betweenness <- Node_betweenness_centrality_plot(betweenness_all, labels_y, 3)
# p_pagerank <- Node_pagerank_centrality_plot(pagerank_all, labels_y, 3)
# p_hub_score <- Node_hub_score_centrality_plot(hub_score_centrality_all, labels_y, 3)
# 
# aligned_plots <- align_plots(p_hub_score, p_eigen,p_pagerank, p_betweenness,  align = "v", axis = "tblr")
# # 绘制对齐后的图形
# aligned_plots_COMPLINE <- plot_grid(aligned_plots[[1]], aligned_plots[[2]], aligned_plots[[3]], aligned_plots[[4]], ncol = 2)
# ggsave("Node_centrality_time_varying.pdf", aligned_plots_COMPLINE, width = 16, height = 8)
# 
# #################################################################################################################
# 
# for (t1 in (1:1155)){
#     g <- graph_from_adjacency_matrix(matrix(move_infection[,,t1]%>% t(), nrow=31, byrow=TRUE), mode = "directed",weighted = TRUE)
#     eigenvector_centrality[t1] <- eigen_centrality(g,directed = TRUE,weights =E(g)$weight)$vector%>% which.max()
#     eigenvector_centrality_all[,t1] <- (eigen_centrality(g,directed = TRUE,weights =E(g)$weight)$vector)    
#     pagerank[t1] <- page_rank(g,directed = TRUE,weights =E(g)$weight)$vector%>% which.max()
#     pagerank_all[,t1] <- page_rank(g,directed = TRUE,weights =E(g)$weight)$vector
#     g <- graph_from_adjacency_matrix(matrix(move_infection[,,t1] , nrow=31, byrow=TRUE), mode = "directed",weighted = TRUE)
#     degree_centrality[t1] <-  strength(g,weights =E(g)$weight)%>% which.max()
#     degree_centrality_all[,t1] <-  strength(g,weights =E(g)$weight) 
#     betweenness[t1] <- betweenness(g,directed = TRUE,weights =1/E(g)$weight)%>% which.max()
#     betweenness_all[,t1] <- betweenness(g,directed = TRUE,weights =1/E(g)$weight)
#     hub_score_centrality[t1] <- hub_score(g,weights =E(g)$weight)$vector %>% which.max()
#     hub_score_centrality_all[,t1] <- hub_score(g,weights =E(g)$weight)$vector
# }
# p_degree <- Node_Degree_centrality_plot(degree_centrality_all, labels_y, 3)
# p_eigen <- Node_Eigenvector_centrality_plot(eigenvector_centrality_all, labels_y, 3)
# p_betweenness <- Node_betweenness_centrality_plot(betweenness_all, labels_y, 3)
# p_pagerank <- Node_pagerank_centrality_plot(pagerank_all, labels_y, 3)
# p_hub_score <- Node_hub_score_centrality_plot(hub_score_centrality_all, labels_y, 3)
# 
# aligned_plots <- align_plots(p_hub_score, p_eigen,p_pagerank, p_betweenness,  align = "v", axis = "tblr")# 绘制对齐后的图形
# 
# aligned_plots_COMPLINE_IN <- plot_grid(aligned_plots[[1]], aligned_plots[[2]], aligned_plots[[3]], aligned_plots[[4]], ncol = 2)
# ggsave("Node_centrality_time_varying_in.pdf", aligned_plots_COMPLINE_IN, width = 16, height = 8)

#################################################################################################################

```




```{R,effective number}
library(tidyverse)
library(ggpubr)
library(ggplot2)
province <- c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
# pred_ili_dfRt <- get_credible_intervals_data(tail(multistrain_fit$Rt1[,,seq(2, 1155)],100),0,province)
# 
# library(dplyr)
# # 通过创建一个新的变量将周数分组，然后对每个分组进行求和
# pred_ili_dfRt1 <- pred_ili_dfRt %>%
#   mutate(group = (week - 1) %/% 60 + 1) %>%
#   group_by(Subtype, group) %>%
#   summarise(sum = mean(q50, na.rm = TRUE))
# source("plot_RE_map.R")
# plotRE <- list()
# pred_ili_dfRt_month <- array(0, dim = c(20, 31))
# # 计算每bi-monthly天的累计数据 
# for (i in 1:num_intervals) {
# plotRE[[i]] <- plot_RE_map(pred_ili_dfRt1 %>% filter(group == i) %>% pull(sum))
# }
# plotRE2 <- plot_grid(plotlist = plotRE, ncol = 4)
# ggsave("plot_RE_2.pdf", plotRE2, width = 18, height = 15)
# 
# plotRT1 <- ggplot() +
#   geom_ribbon(data =pred_ili_dfRt,aes(x = week,ymin = q025, ymax = q975, fill = "95% CrI"), alpha = 0.1) +
#   geom_ribbon(data =pred_ili_dfRt,aes(x = week,ymin = q25, ymax = q75, fill = "50% CrI"), alpha = 0.2) +
#   geom_line(data =pred_ili_dfRt,aes(x = week,y = q50, color = "Mean"),size = 0.2) +
#   facet_wrap(~ Subtype, ncol = 8, scales = "free_y", labeller = custom_labeller) +
#   labs(x = "Time",y = "Re(t)") +
#     scale_x_continuous(breaks = seq(from = 0, to =  365.25*3+4, by = 365.25), labels = c("2020","2021","2022","2023"))+
#   theme_bw() + 
#   theme(
#     panel.grid.major = element_blank(),
#     panel.grid.minor = element_blank(),
#     panel.border = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
#     plot.subtitle = element_text(size = 12, hjust = 0.5),
#     axis.title = element_text(size = 12),
#     axis.text = element_text(size = 10),
#     legend.position = c(0.97, 0),  
#     legend.justification = c(1, 0)  
#     ) +scale_fill_manual(values = c("95% CrI" = "red", "50% CrI" = "red")) +
#   scale_color_manual(values = c("Mean" = "red"))+
#     guides(
#      fill = guide_legend(title = "Re"),
#      color = guide_legend(title = "Re")
#      )
# plotRT1
# ggsave("Effective_number_time_varying.pdf", plotRT1, width = 19, height = 11)

```

```{R, ploting airquality index}
# province <- c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
# air <- multistrain_fit$air
# AirQuality <- data_lst$AirQuality 
# start_date <- as.Date("2020-01-01");end_date <- as.Date(start_date + 1154);dates <- seq(start_date, end_date, by = "day")
# # 设置国家代码
# countries <-province;
# AirQuality_impact <- array(0, dim = c(500, 31, 1155))
# for(country in 1:31) {
#   for (day in 1:1155) {
#     for (nums in 1:500) {
#       AirQuality_impact[nums, country, day] <- exp(-air[nums]*AirQuality[day,country])
#     }
#   }
# }
# 
# source("calculate_RT_summary.R")
# nums <- 1:500;
# Air_Impact <- calculate_RT_summary(nums, countries, dates, AirQuality_impact)
# Air_Impact_plot <-ggplot() +
#   geom_ribbon(data =Air_Impact,aes(x = days,ymin = lower_ci, ymax = upper_ci, fill = "95% CrI"), alpha = 0.1) +
#   geom_line(data =Air_Impact,aes(x = days,y = mean_value, color = "Mean"),size = 0.1, linetype = "dashed") +
#   facet_wrap(~ countries, ncol = 8, scales = "free_y", labeller = custom_labeller) +
#   labs(x = "Time",y = "Air quality impact") +
#   scale_x_date(breaks = seq(as.Date("2020-01-01"), as.Date("2023-02-28"), by = "year"), labels = c("2020", "2021", "2022", "2023")) +
#   theme_bw() + 
#   theme(
#     panel.grid.major = element_blank(),
#     panel.grid.minor = element_blank(),
#     panel.border = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
#     plot.subtitle = element_text(size = 12, hjust = 0.5),
#     axis.title = element_text(size = 12),
#     axis.text = element_text(size = 10),
#     legend.position = c(0.97, 0.05),  
#     legend.justification = c(1, 0)  
#     ) +scale_fill_manual(values = c("95% CrI" = "red", "50% CrI" = "red")) +
#   scale_color_manual(values = c("Mean" = "red"))+
#     guides(
#      fill = guide_legend(title = "Air quality impact"),
#      color = guide_legend(title = "Air quality impact")
#      )
# ggsave("Air_Impact_plot_time_varying.pdf", Air_Impact_plot, width = 19, height = 11)
# 
# 
# 
# library(dplyr)
# Air_Impact <- Air_Impact %>%
#   mutate(days_numeric = as.numeric(difftime(days, as.Date("2020-01-01"), units = "days")) + 1)
# Air_Impact1 <- Air_Impact %>%
#   mutate(group = (days_numeric - 1) %/% 60 + 1) %>%
#   group_by(countries, group) %>%
#   summarise(sum = mean(mean_value, na.rm = TRUE))
# plot_Air_Impact <- list()
# Air_Impact_month <- array(0, dim = c(20, 31))
# # 计算每bi-monthly天的累计数据 
# source("plot_Air_impact_map.r")
# for (i in 1:num_intervals) {
# plot_Air_Impact[[i]] <- plot_Air_impact_map(Air_Impact1 %>% filter(group == i) %>% pull(sum))
# }
# plot_Air_Impact2 <- plot_grid(plotlist = plot_Air_Impact, ncol = 4)
# ggsave("plot_Air_Impact_2.pdf", plot_Air_Impact2, width = 18, height = 15)

```


```{R}

dailyincidence <- readMat("case/dailyincidence.mat")
# 将数据转换为数据框# 将数据转换为数据框
dailyincidence <- as.data.frame(dailyincidence)
dailyincidence[2:nrow(dailyincidence), 2:ncol(dailyincidence)] <- lapply(dailyincidence[2:nrow(dailyincidence), 2:ncol(dailyincidence)], as.numeric)
# 创建时间序列
provincenames <- c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongol', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Xizang', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
start_date <- as.Date("2020-01-01")
end_date <- as.Date("2023-02-28")
date_range <- seq(start_date, end_date, by = "day")
dailyincidence <- as.data.frame(dailyincidence)
colnames(dailyincidence) <- date_range
rownames(dailyincidence) <- provincenames 
date_groups <- floor_date(date_range, "2 months")
num_groups <- length(unique(date_groups))


I_states <- apply(multistrain_fit$I[seq(6001,6400),,], c(2,3), mean) # 31*1155
E_states <- apply(multistrain_fit$E[seq(6001,6400),,], c(2,3), mean) 
thetap <- multistrain_fit$thetap[seq(6001,6400,1)] # size 300*31
ap1 <- tail(multistrain_fit$rate,1000) # size 300*1
npi <- multistrain_fit$npi
NPI <- data_lst$NPI1/100

p_report <- array(0, dim = c(100, 31, 1155))
for(province in 1:31) { 
  for (nums in 1:100) {
  for (day in 1:1155) {
      p_report[nums,province,day] = thetap[nums]*(exp(ap1[nums]*NPI[province,day]))}
  }
}

p_report1 <- apply(p_report,c(2,3),mean)

move_infection  <- array(0, dim = c(31, 31,1155))
# array(0, dim = c(500, 31, 1155))
for(country1 in 1:31) {
  for(country2 in 1:31) {
  for (day in 1:1155) {
      move_infection[country2, country1, day] <- (Mobility[day,country1,country2]*((1-p_report1[country2,day])*I_states[country2,day]+E_states[country2,day]))
    }
  }
}

move_infection <- apply(move_infection, c(1, 2, 3), as.numeric)

cumulative_move_infection <- array(0, dim = c(31, 31, num_groups))
data_lst_week <- array(0, dim = c(31,num_groups))


for (k in 1:num_groups) {
  for (i in 1:31) {
     for (j in 1:31) {
      group_dates <- which(date_groups == unique(date_groups)[k])
      cumulative_move_infection[i, j, k] <- sum(move_infection[i, j, group_dates], na.rm = TRUE) }
      data_lst_week[i,k] <- sum(dailyincidence[i, group_dates], na.rm = TRUE)
   }
}

for (i in 1:num_groups) {
g1[[i]] <- graph_from_adjacency_matrix(matrix(cumulative_move_infection[,,i]%>% t(), nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
# plot_eweight1[[i]] <- plot_network_eweight(g)
g2[[i]] <- graph_from_adjacency_matrix(matrix(cumulative_move_infection[,,i], nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
# plot_betweenness1[[i]] <- plot_network_betweenness(g)
# plot_effedistance1[[i]] <- plot_network_effedistance(g)
}


data_list2 <- lapply(1:num_groups, function(i) {
  province_data <-   matrix((E(g2[[i]])$weight),nrow = 31, ncol = 31,dimnames = list(provincenames, provincenames))%>% 
    melt(varnames = c("Origin", "Destination"),value.name = "Exports") %>% 
    transform(Month = months[i])
})
data <- do.call(rbind, data_list2)
data <- data %>%
  mutate(Exports = cut(Exports, 
                              breaks = c(0, 100, 2500,10000,40000, 90000, 160000,  Inf), 
                              labels = c("0-100","100-2500", "2500-10000","10000-40000", "40000-90000", "90000-160000", ">160000")))
data$Month <- factor(data$Month, levels = months)

plot_eweight2 <- ggplot(data, aes(x = Destination, y = Origin, fill = (Exports))) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("white", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C","#FFDDC1", "#CA0020"),
                    na.value = "white") +
  facet_wrap(~ Month, ncol = 5,  scales = "fixed") + # ,labeller = labeller(Month = setNames(as.list(labelsbimonth), unique(data$Month)))
  theme_bw() +
  theme(
    # 核心修改部分
    legend.position = c(0.85,0.085),  # 或使用数值坐标微调
    legend.box.margin = margin(l = 1, r=1, t=1, b=1),  # 左侧留白
    legend.justification = "left",  # 左对齐
    plot.margin = margin(r = 1, b = 1, l = 1,t = 1, unit = "cm"),  # 右侧扩展空间
    
    # 保留原有样式
    axis.text.x = element_text(angle = 90, hjust = 1, size = 7),
    axis.text.y = element_text( size = 7),
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    strip.text = element_text(size = 15),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid = element_blank()
  ) +
  labs(fill = "Weight\ncentrality", x = "Destination ", y = "Origin")
plot_eweight2

#http://127.0.0.1:43167/graphics/plot_zoom_png?width=1669&height=1332

ggsave("Extended Data Fig 5.pdf", plot_eweight2, width = 16.69, height = 13.32)





data_list1 <- lapply(1:num_groups, function(i) {
  province_data <-   matrix(edge.betweenness(g2[[i]],directed = FALSE,weights =1/(1+E(g2[[i]])$weight)),nrow = 31, ncol = 31,dimnames = list(provincenames, provincenames)) %>% 
    melt(varnames = c("Origin", "Destination"),value.name = "Exports") %>% 
    transform(Month = months[i])
})
data <- do.call(rbind, data_list1)
data <- data %>%
  mutate(Exports = cut(Exports, 
                              breaks = c(0, 5, 10, 30, 50, 80, 100, Inf), 
                              labels = c("0-5", "5-10", "10-30", "30-50", "50-80","80-100", ">100")))
data$Month <- factor(data$Month, levels = months)
plot_betweenness2 <- ggplot(data, aes(x = Destination, y = Origin, fill = Exports)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("white", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C","#FFDDC1", "#CA0020"),
                    na.value = "white") +
  facet_wrap(~ Month, ncol = 5, scales = "fixed") +
  theme_bw() +
  theme(
    # 核心修改部分
    legend.position = c(0.85,0.085),  # 或使用数值坐标微调
    legend.box.margin = margin(l = 1, r=1, t=1, b=1),  # 左侧留白
    legend.justification = "left",  # 左对齐
    plot.margin = margin(r = 1, b = 1, l = 1,t = 1, unit = "cm"),  # 右侧扩展空间
    
    # 保留原有样式
    axis.text.x = element_text(angle = 90, hjust = 1, size = 7),
    axis.text.y = element_text( size = 7),
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    strip.text = element_text(size = 15),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid = element_blank()
  )+
  labs(fill = "Betweenness\ncentrality", x = "Destination", y = "Origin")
plot_betweenness2

ggsave("Extended Data Fig 6.pdf", plot_betweenness2, width = 16.69, height = 13.32)



library(igraph)



# Calculate vertex closeness
closeness_values <- closeness(g1[[1]])
# Function to calculate edge closeness based on vertex closeness
edge_closeness <- function(graph, closeness_values) {
  edge_closeness_values <- numeric(ecount(graph))
  for (i in 1:ecount(graph)) {
    edge <- ends(graph, i)
    edge_closeness_values[i] <- (closeness_values[edge[1]] + closeness_values[edge[2]]) / 2
  }
  return(edge_closeness_values)
}

# Calculate edge closeness values
# edge_closeness_values <- edge_closeness(g, closeness_values)
# Print the edge closeness values



data_list1 <- lapply(1:num_groups, function(i) {
  province_data <-   matrix(edge_closeness(g1[[i]],closeness(g1[[i]])),nrow = 31, ncol = 31,dimnames = list(provincenames, provincenames)) %>% 
    melt(varnames = c("Origin", "Destination"),value.name = "Exports") %>% 
    transform(Month = months[i])
})
data <- do.call(rbind, data_list1)
data <- data %>%
  mutate(Exports = cut(Exports, 
                              breaks = c(0, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, Inf), 
                              labels = c("0-0.03", "0.03-0.04", "0.04-0.05", "0.05-0.06", "0.06-0.07","0.07-0.08", ">0.08")))
data$Month <- factor(data$Month, levels = months)
plot_closeness2 <- ggplot(data, aes(x = Destination, y = Origin, fill = Exports)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("white", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C","#FFDDC1", "#CA0020"),
                    na.value = "white") +
  facet_wrap(~ Month, ncol = 5, scales = "fixed") +
  theme_bw() +
  theme(
    # 核心修改部分
    legend.position = c(0.85,0.085),  # 或使用数值坐标微调
    legend.box.margin = margin(l = 1, r=1, t=1, b=1),  # 左侧留白
    legend.justification = "left",  # 左对齐
    plot.margin = margin(r = 1, b = 1, l = 1,t = 1, unit = "cm"),  # 右侧扩展空间
    
    # 保留原有样式
    axis.text.x = element_text(angle = 90, hjust = 1, size = 7),
    axis.text.y = element_text( size = 7),
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    strip.text = element_text(size = 15),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid = element_blank()
  )+
  labs(fill = "Betweenness\ncentrality", x = "Destination", y = "Origin")
# plot_closeness2
# 
# ggsave("Figure S19_link_plot_closenness_2.pdf", plot_closeness2, width = 16.69, height = 13.32)



library(igraph)
  library(ggplot2)
  library(ggraph)
  library(maps)
  library(dplyr)
  library(sf)
  library(stringr)
  library(stringr)
  library(leiden)
  library(rnaturalearth)
  library(rnaturalearthdata)
  library(ggplot2)
  library(sf)
  library(dplyr)
  # 读取中国省份的地理数据
  # china_map <- st_read("E:/Dong/one_drive/OneDrive - The University Of Hong Kong/_HMRF_2021_HIGHER_ORDER_MODEL/china/cn.shp")
  # china_map <- china_map %>%
  #   mutate(NAME = str_replace(name, " .*", ""))
  province <-c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongol', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Xizang', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
  
  china_province_map_data <- ne_states(country = "China", returnclass = "sf")
  taiwan_map_data <- ne_countries(country = "taiwan")
  common_columns <- intersect(colnames(china_province_map_data), colnames(taiwan_map_data))
  china_province_map_data <- china_province_map_data[, common_columns]
  taiwan_map_data <- taiwan_map_data[, common_columns]
  china_map <- rbind(china_province_map_data, taiwan_map_data)
options(warn = 0)
for (i in 1:num_groups) {
  g1[[i]] <- graph_from_adjacency_matrix(matrix(cumulative_move_infection[,,i]%>% t(), nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
  # plot_eigenvector1[[i]] <- plot_eigenvector_centrality_map(g1[[i]]) # in 
  # plot_pagerank1[[i]] <- plot_page_rank_centrality_map(g[[i]]) # in
  g2[[i]] <- graph_from_adjacency_matrix(matrix(cumulative_move_infection[,,i] , nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
  # plot_degree1[[i]] <- plot_degree_centrality_map(g2[[i]]) # out degree
  # plot_hub_score1[[i]] <- plot_hub_score_centrality_map(g[[i]]) # out degree
  # plot_betweenness1[[i]] <- plot_betweenness_centrality_map(g[[i]]) # path
}
# E(g1[[6]])$weight <- 0.99*E(g1[[i]])$weight +0.005*E(g1[[5]])$weight +0.005*E(g1[[7]])$weight 
#############################################################################################################################################
data_list <- lapply(1:num_groups, function(i) {
  province_data <- data.frame(name = province,value =strength(g1[[i]], mode="out", weights=sqrt(E(g1[[i]])$weight)))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0, 100, 300, 500, 600, 800, 1000,Inf), 
                                    labels = c("0-100", "100-300","300-500", "500-600", "600-800","800-1000", ">1000")))
# data$Month <- factor(data$Month, levels = months)
plot_degree2 <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray95", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C","#FFDDC1", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed")+
  labs(fill = expression(sqrt(Degree(out))))+
  theme(strip.background = element_rect(fill = "white", color = NA),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_degree2
ggsave("Figure S8_plot_degree21.pdf", plot_degree2, width = 14, height = 9)

data_list <- lapply(1:num_groups, function(i) {
  province_data <- data.frame(name = province,value =strength(g1[[i]], mode="in", weights=sqrt(E(g1[[i]])$weight)))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i])# %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0, 100, 300, 500, 600, 800, 1000,Inf), 
                                    labels = c("0-100", "100-300","300-500", "500-600", "600-800","800-1000", ">1000")))
data$Month <- factor(data$Month, levels = months)
plot_degree2in <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray95", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C","#FFDDC1", "#CA0020"),
                  na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = expression(sqrt(Degree("in"))))+
  theme(
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_degree2in
ggsave("Figure S11_plot_degree2_in.pdf", plot_degree2in, width = 14, height = 9)
######################################################################################################################
# eigenvalue 
data_list <- lapply(1:num_groups, function(i) {
  province_data <- data.frame(name = province,value =eigen_centrality(g1[[i]], weights = E(g1[[i]])$weight,directed = TRUE,scale = TRUE)$vector)
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i]) %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0,0.01,0.1,0.2,0.5,0.8,1), 
                                    labels = c("0-0.01", "0.01-0.1","0.1-0.2", "0.2-0.5","0.5-0.8", "0.8-1")))
data$Month <- factor(data$Month, levels = months)
plot_eigenvector2in <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray90", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = "Eigenvector(in)")+
  theme(strip.background = element_rect(fill = "white", color = NA),
        #strip.text = element_blank(),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_eigenvector2in
ggsave("Extended Data Fig 4.pdf", plot_eigenvector2in, width = 14, height = 9)

data_list <- lapply(1:num_groups, function(i) {
  province_data <- data.frame(name = province,value =eigen_centrality(g2[[i]], weights = E(g2[[i]])$weight,directed = TRUE,scale = TRUE)$vector)
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i]) %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0,0.01,0.1,0.2,0.5,0.8,1), 
                                    labels = c("0-0.01", "0.01-0.1","0.1-0.2", "0.2-0.5","0.5-0.8", "0.8-1")))
data$Month <- factor(data$Month, levels = months)
plot_eigenvector2 <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray90", "#CDDDE5", "#7BABCA", "#2879B0", "#2E5C8C", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = "Eigenvector(out)")+
  theme(strip.background = element_rect(fill = "white", color = NA),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_eigenvector2
ggsave("Extended Data Fig 3.pdf", plot_eigenvector2, width = 14, height = 9)

library(R.utils)
# compressPDF("Extended Data Fig 3.pdf",outfile = "Extended Data Fig 3_com.pdf",version = "1.4")

######################################################################################################################

# hubscore
data_list <- lapply(1:num_groups, function(i) {
  province_data <- data.frame(name = province,value = sqrt(sqrt(hub_score(g1[[i]],weights = E(g1[[i]])$weight)$vector)))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i]) %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0,0.1,0.2,0.4,0.7,1), 
                                    labels = c("0-0.1","0.1-0.2", "0.2-0.4","0.4-0.7", "0.7-1")))
data$Month <- factor(data$Month, levels = months)
plot_hub_score2out <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray95", "#CDDDE5", "#7BABCA", "#2879B0", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = "Hub score(out)")+
  theme(#strip.text = element_blank(),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_hub_score2out
ggsave("Figure S9_plot_hub_score2_out.pdf", plot_hub_score2out, width = 14, height = 9)

data_list <- lapply(1:num_groups, function(i) {
  province_data <- data.frame(name = province,value =sqrt(hub_score(g2[[i]],weights = E(g2[[i]])$weight, )$vector))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i]) %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0,0.1,0.2,0.4,0.7,1), 
                                    labels = c("0-0.1","0.1-0.2", "0.2-0.4","0.4-0.7","0.7-1")))
data$Month <- factor(data$Month, levels = months)
plot_hub_score2in <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray95", "#CDDDE5", "#7BABCA", "#2879B0", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = "Hub score(in)")+
  theme(#strip.text = element_blank(),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_hub_score2in
ggsave("Figure S12_plot_hub_score2_in.pdf", plot_hub_score2in, width = 14, height = 9)
######################################################################################################################
# page rank
data_list <- lapply(1:num_groups, function(i) {
  pagerank_vector=page_rank(g1[[i]],algo = c("prpack", "arpack"),vids = V(g1[[i]]),directed = TRUE,weights =E(g1[[i]])$weight)$vector
  province_data <- data.frame(name = province,value=scale(pagerank_vector, center = min(pagerank_vector), scale = max(pagerank_vector) - min(pagerank_vector)))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i]) %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0,0.1,0.2,0.5,0.8,1), 
                                    labels = c("0-0.1","0.1-0.2", "0.2-0.5","0.5-0.8","0.8-1")))
data$Month <- factor(data$Month, levels = months)
plot_pagerank2in <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray95", "#CDDDE5", "#7BABCA",  "#2879B0", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = "Page rank(in)")+
  theme(strip.background = element_rect(fill = "white", color = NA),
        #strip.text = element_blank(),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_pagerank2in
ggsave("Figure S13_plot_pagerank2_in.pdf", plot_pagerank2in, width = 14, height = 9)

data_list <- lapply(1:num_groups, function(i) {
  pagerank_vector=page_rank(g2[[i]],algo = c("prpack", "arpack"),vids = V(g2[[i]]),directed = TRUE,weights =E(g2[[i]])$weight)$vector
  province_data <- data.frame(name = province,value=scale(pagerank_vector, center = min(pagerank_vector), scale = max(pagerank_vector) - min(pagerank_vector)))
  china_map <- china_map %>%full_join(province_data, by = "name") %>% transform(Month = months[i]) %>% transform(Month = months[i])
})
data <- do.call(rbind, data_list)
data <- data %>% mutate(value = cut(value, breaks = c(0,0.1,0.2,0.5,0.8,1), 
                                    labels = c("0-0.1","0.1-0.2", "0.2-0.5","0.5-0.8","0.8-1")))
data$Month <- factor(data$Month, levels = months)
plot_pagerank2 <- ggplot(data = data) +
  geom_sf(aes(fill = value)) +
  scale_fill_manual(values = c("gray95", "#CDDDE5", "#7BABCA",  "#2879B0", "#CA0020"),
                    na.value = "white") +    theme_void() +
  facet_wrap(~ Month, ncol = 5, nrow = 4, scales = "fixed",
             labeller = labeller(Month = setNames(as.list(months), unique(data$Month)))) +
  labs(fill = "Page rank(out)")+
  theme(strip.background = element_rect(fill = "white", color = NA),
    legend.title = element_text(size = 10),  # 调整图例标题字体大小
    legend.text = element_text(size = 10),   # 调整图例文本字体大小
    plot.title = element_text(size = 10),    # 调整标题字体大小
    plot.margin = margin(r = 0, unit = "cm"),
    legend.position = c(0.9,0.15)
  )
plot_pagerank2
ggsave("Figure S10_plot_pagerank2.pdf", plot_pagerank2, width =14, height = 9)



```





```{R, ploting temp impact}
Mean_Temp <- data_lst$Mean_Temp
temp <- multistrain_fit$temp
Mean_Temp <- data.frame(Mean_Temp)
start_date <- as.Date("2020-01-01");end_date <- as.Date(start_date + 1154);date_range <- seq(start_date, end_date, by = "day")
Mean_Temp$Date <- date_range
Mean_Temp_impact <- array(0, dim = c(500, 31, 1155))
for(country in 1:31) {
  for (day in 1:1155) {
    for (nums in 1:500) {
      Mean_Temp_impact[nums, country, day] <- exp(-temp[nums]*Mean_Temp[day,country])
    }
  }
}
nums <- 1:500;
Temp_impact <- calculate_RT_summary(nums, countries, dates, Mean_Temp_impact)
Temp_impact_plot <-ggplot() +
  geom_ribbon(data =Temp_impact,aes(x = days,ymin = lower_ci, ymax = upper_ci, fill = "95% CrI"), alpha = 0.1) +
  geom_line(data =Temp_impact,aes(x = days,y = mean_value, color = "Mean"),size = 0.1, linetype = "dashed") +
  facet_wrap(~ countries, ncol = 8, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Time",y = "Temperature Impact") +
  scale_x_date(breaks = seq(as.Date("2020-01-01"), as.Date("2023-02-28"), by = "year"), labels = c("2020", "2021", "2022", "2023")) +
  theme_bw() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = c(0.97, 0.05),  
    legend.justification = c(1, 0)  
    ) +scale_fill_manual(values = c("95% CrI" = "red", "50% CrI" = "red")) +
  scale_color_manual(values = c("Mean" = "red"))+
    guides(
     fill = guide_legend(title = "Temperature impact"),
     color = guide_legend(title = "Temperature impact")
     )
ggsave("Temperature_plot_time_varying.pdf", Temp_impact_plot, width = 19, height = 11)



library(dplyr)
Temp_impact <- Temp_impact %>%
  mutate(days_numeric = as.numeric(difftime(days, as.Date("2020-01-01"), units = "days")) + 1)
Temp_impact <- Temp_impact %>%
  mutate(group = (days_numeric - 1) %/% 60 + 1) %>%
  group_by(countries, group) %>%
  summarise(sum = mean(mean_value, na.rm = TRUE))
plot_Temp_impact <- list()
# 计算每bi-monthly天的累计数据 
source("plot_Temperature_impact_map.r")
for (i in 1:num_intervals) {
plot_Temp_impact[[i]] <- plot_Temperature_impact_map(Temp_impact %>% filter(group == i) %>% pull(sum))
}
plot_Temp_impact2 <- plot_grid(plotlist = plot_Temp_impact, ncol = 4)
ggsave("plot_Temp_impact_2.pdf", plot_Temp_impact2, width = 18, height = 15)

```





```{R}
library(tidyverse)
library(ggpubr)
library(ggplot2)
#load("E:/Dong/one_drive/OneDrive - The University Of Hong Kong/model_str_multi_AH_T_H_All/model_str_multi_T_H_All_NB.Rdata")
source("get_credible_intervals_data.r")
source("get_credible_intervals_data_whole.r")
row_names <-c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongolia', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
# pred_ili_df_S1 <- get_credible_intervals_data(multistrain_fit$E_2,skip+365.25*5,row_names)
# pred_ili_df_V1 <- get_credible_intervals_data(multistrain_fit$V_2,skip+365.25*5,row_names)
# pred_ili_df_R1 <- get_credible_intervals_data(multistrain_fit$I_2,skip+365.25*5,row_names)
pred_ili_dfS <- get_credible_intervals_data(multistrain_fit$S,0+365.25*0,row_names)
# pred_ili_dfV <- get_credible_intervals_data(multistrain_fit$V,0+365.25*0,row_names)
pred_ili_dfR <- get_credible_intervals_data(multistrain_fit$R,0+365.25*0,row_names)
# pred_ili_dftheap <- get_credible_intervals_data(multistrain_fit$thetap,0+365.25*0,row_names)

# pred_ili_dfE <- get_credible_intervals_data(multistrain_fit$E,0+365.25*0,row_names)
# pred_ili_dfI <- get_credible_intervals_data(multistrain_fit$I,0+365.25*0,row_names)
#######################################################################################################################
# pred_ili_dfBeta_KT <- get_credible_intervals_data(multistrain_fit$Rt,skip+365.25*0,row_names)
# plotRt <- list()
# for(i in 1:K) {
# plotRt[[i]] <- ggplot() + geom_ribbon(data = pred_ili_dfBeta_KT %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q025, ymax = q975, fill = "Rt"), alpha = 0.2, show.legend = TRUE) +
#   geom_ribbon(data = pred_ili_dfBeta_KT %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q25, ymax = q75, fill = "Rt"), alpha = 0.2, show.legend = FALSE) +
#   geom_line(data = pred_ili_dfBeta_KT %>% filter(Subtype == row_names[i]), aes(x = week + 0, y = q50, colour = "Rt"), show.legend = TRUE) +
#   ylim(0,3)
# }
# plotRt_combined_plot1 <- ggarrange(plotlist = plotRt, ncol = 2, nrow = 2, align = "hv", common.legend = FALSE)
##########################################################################################################################
plot_list1 <- list()
for(i in 1:K) {
  plot_list1[[i]] <- ggplot() +  geom_ribbon(data = pred_ili_dfS %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q025, ymax = q975, fill = "S"), alpha = 0.2, show.legend = TRUE) +
  geom_ribbon(data = pred_ili_dfS %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q25, ymax = q75, fill = "S"), alpha = 0.2, show.legend = FALSE) +
  geom_line(data = pred_ili_dfS %>% filter(Subtype == row_names[i]), aes(x = week + 0, y = q50, colour = "S"), show.legend = TRUE) +
  # geom_ribbon(data = pred_ili_dfV %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q025, ymax = q975, fill = "V"), alpha = 0.2, show.legend = TRUE) +
  # geom_ribbon(data = pred_ili_dfV %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q25, ymax = q75, fill = "V"), alpha = 0.2, show.legend = FALSE) +
  # geom_line(data = pred_ili_dfV %>% filter(Subtype == row_names[i]), aes(x = week + 0, y = q50, colour = "V"), show.legend = TRUE) +
  geom_ribbon(data = pred_ili_dfR %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q025, ymax = q975, fill = "R"), alpha = 0.2, show.legend = TRUE) +
  geom_ribbon(data = pred_ili_dfR %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q25, ymax = q75, fill = "R"), alpha = 0.2, show.legend = FALSE) +
  geom_line(data = pred_ili_dfR %>% filter(Subtype == row_names[i]), aes(x = week + 0, y = q50, colour = "R"), show.legend = TRUE) +
  # geom_ribbon(data = pred_ili_dfE %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q025, ymax = q975, fill = "E"), alpha = 0.2, show.legend = TRUE) +
  # geom_ribbon(data = pred_ili_dfE %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q25, ymax = q75, fill = "E"), alpha = 0.2, show.legend = FALSE) +
  # geom_line(data = pred_ili_dfE %>% filter(Subtype == row_names[i]), aes(x = week + 0, y = q50, colour = "E"), show.legend = TRUE) +
  # geom_ribbon(data = pred_ili_dfI %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q025, ymax = q975, fill = "I"), alpha = 0.2, show.legend = TRUE) +
  # geom_ribbon(data = pred_ili_dfI %>% filter(Subtype == row_names[i]), aes(x = week + 0, ymin = q25, ymax = q75, fill = "I"), alpha = 0.2, show.legend = FALSE) +
  # geom_line(data = pred_ili_dfI %>% filter(Subtype == row_names[i]), aes(x = week + 0, y = q50, colour = "I"), show.legend = TRUE) +
  theme(legend.position = c(0.9, 0.77),legend.key = element_blank(),legend.background = element_blank(),legend.box.background = element_blank(),text = element_text(size = 12))+
    scale_x_continuous(breaks = seq(from = 0, to =  365.25*3+1, by = 365.25), labels = c("2020","2021","2022","2023"))+
    facet_wrap(~ Variable, ncol = 6, scales = "free_y", labeller = custom_labeller) +
    ylab("Proportion") + xlab("Year") +
    scale_fill_manual(name = row_names[i], values = c("S" = "red","V" = "blue","R" = "green","E" = "purple","I" = "grey" )) + #"S1" = "gray","V1" = "gray","R1" = "gray"
    scale_color_manual(name =  row_names[i], values = c( "S" = "red","V" = "blue","R" = "green","E" = "purple","I" = "grey"))
}
combined_plot1 <- ggarrange(plotlist = plot_list1, ncol = 6, nrow = 6, align = "hv", common.legend = FALSE)
# Combine the legends
combined_plotRSV <- combined_plot1 + theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Legend Title"), colour = guide_legend(title = NULL))
#ggsave(filename = "subtype_AH_T1.pdf", plot = combined_plot1, width =29, height = 15)
# Display the combined plot
print(combined_plotRSV)
combined_plotRSV
``` 





```{r plotResults, dependson = c("load_results", "load_data"), fig.cap = "Model fit to the data. Top panel has the fit to the ILI consultation data (blue). Furthermore, the panel highlights the causes of ILI, i.e. by each influenza strain or other non-flu causes. The bottom panel has the fit to the virological confirmation data.", echo = T}
# Plotting the fits
# ILI data
source('F:\\Dong\\SPH Dropbox\\Wang Dong\\model_str_multi_AH_T_H_All\\plot_expanded_draws.R')
library(bayesplot)
library(posterior)
library(magrittr)
library(dplyr)
library(purrr)
library(forcats)
library(tidyr)
library(modelr)
library(ggdist)
library(tidybayes)
library(ggplot2)
library(cowplot)
library(rstan)
library(RColorBrewer)

###############################################################################################
# plot_expanded_draws(stan_fit %>% tidybayes::gather_draws(a0[1]),"a0")
# plot_expanded_draws(stan_fit %>% tidybayes::gather_draws(a1[1]),"a1")
# plot_expanded_draws(stan_fit %>% tidybayes::gather_draws(a2[1]),"a2")
# plot_expanded_draws(stan_fit %>% tidybayes::gather_draws(b1[1]),"b1")
# plot_expanded_draws(stan_fit %>% tidybayes::gather_draws(d1[1]),"d1")
# plot_expanded_draws(stan_fit %>% tidybayes::gather_draws(npi[1]),"npi")

```





```{r plotResults, dependson = c("load_results", "load_data"), fig.cap = "Model fit to the data. Top panel has the fit to the ILI consultation data (blue). Furthermore, the panel highlights the causes of ILI, i.e. by each influenza strain or other non-flu causes. The bottom panel has the fit to the virological confirmation data.", echo = T}
# Plotting the fits
# 
# # ILI data
# ili_df <- data_lst$cases %>% as_data_frame() %>%dplyr::mutate(value = H1)%>% mutate(week = row_number()) %>%
#   ungroup()
# thetap_df <- multistrain_fit$thetap %>% as.data.frame.table() %>%
# rename(np = iterations, thetap = Freq) %>%
#   dplyr::mutate(np = as.numeric(np))
# 
# # Then plot draws/tot (with uncertainty) by strain and also plot data with pos/tot
# df <- multistrain_fit$PILI %>% as.data.frame.table() %>%
#   rename(np = iterations, week = Var3, Subtype = Var2, value = Freq) %>%
#   dplyr::mutate(
#     np = as.numeric(np),
#     week = as.numeric(week),
#     Subtype = factor(Subtype, labels = c("H1"))
#   )
# #rbinom #pred = rnorm(n(), as.matrix(round(N*(multistrain_fit$PILI)))*as.vector(multistrain_fit$thetap),8)
# pred_ili_df <- df %>% mutate( pred = rbinom(n(), round(N*(multistrain_fit$PILI)),(multistrain_fit$thetap))) %>% mutate(value = pred)
# pred_ili_df <- pred_ili_df %>% group_by(np, week) %>%
#   bind_rows(pred_ili_df) %>% group_by(Subtype,week) %>%
#   summarise(
#     q025 = quantile(value, 0.025),
#     q25 = quantile(value, 0.25),
#     q50 = quantile(value, 0.5),
#     q75 = quantile(value, 0.75),
#     q975 = quantile(value, 0.975)
#   ) %>% ungroup() %>% dplyr::mutate(Subtype = factor(Subtype, levels = c("H1", "H2"))) 
# 
# library(openxlsx)
# wb <- createWorkbook()
# for (i in 1:K) {
#   # 提取每个表格的数据
#   start_row <- (i - 1) * Nweek + 1
#   end_row <- i * Nweek
#   sub_data <- pred_ili_df[start_row:end_row, ]
#   # 将数据添加到Excel工作簿的新Sheet中
#   sheet_name <- paste("Sheet", i, sep = "")
#   addWorksheet(wb, sheet_name)
#   writeData(wb, sheet_name, sub_data)
# }
# saveWorkbook(wb, "pred_ili_df.xlsx", overwrite = TRUE)
# 
# full_names <- countrycode(sourcevar = row_names, origin = "iso2c", destination = "country.name")
# plot_list <- list()
# for(i in 1:K) {
#   plot_list[[i]] <- ggplot() +
#     geom_point(data = ili_df, aes(x = skip + week, y = !!sym(row_names[i]))) +
#     geom_ribbon(data = pred_ili_df %>% filter(Subtype == row_names[i]), aes(x = week, ymin = q025, ymax = q975, fill = "Prediction"), alpha = 0.3, show.legend = TRUE) +
#     geom_ribbon(data = pred_ili_df %>% filter(Subtype == row_names[i]), aes(x = week, ymin = q25, ymax = q75, fill = "Prediction"), alpha = 0.3, show.legend = FALSE) +
#     geom_line(data = pred_ili_df %>% filter(Subtype == row_names[i]), aes(x = week, y = q50, colour = "Prediction"), show.legend = TRUE) +
#     geom_ribbon(data = pred_ili_df_cf %>% filter(Subtype == row_names[i]), aes(x = week + 210.5, ymin = q025cf, ymax = q975cf, fill = "Forecasting"), alpha = 0.3, show.legend = TRUE) +
#     geom_ribbon(data = pred_ili_df_cf %>% filter(Subtype == row_names[i]), aes(x = week + 210.5, ymin = q25cf, ymax = q75cf, fill = "Forecasting"), alpha = 0.3, show.legend = FALSE) +
#     geom_line(data = pred_ili_df_cf %>% filter(Subtype == row_names[i]), aes(x = week + 210.5, y = q50cf, colour = "Forecasting"), show.legend = TRUE) +
#     theme(legend.position = c(0.9, 0.77),legend.key = element_blank(),legend.background = element_blank(),legend.box.background = element_blank(),text = element_text(size = 12))+
#     scale_x_continuous(breaks = c(312, 364.25, 416.5, 468.75, 521, 573.25), labels = c( "2016", "2017", "2018", "2019", "2020","2021"))+
#     ylab("ILI+ proxy/10000") + xlab("Year") +
#     scale_fill_manual(name = full_names[i], values = c("Forecasting" = "blue","Prediction" = "red" )) +
#     scale_color_manual(name =  full_names[i], values = c( "Forecasting" = "blue","Prediction" = "red"))
# }
# combined_plot <- ggarrange(plotlist = plot_list, ncol = 3, nrow = 6, align = "hv", common.legend = FALSE)
# # Combine the legends
# combined_plot <- combined_plot + theme(legend.position = "bottom") +
#   guides(fill = guide_legend(title = "Legend Title"), colour = guide_legend(title = NULL))
# ggsave(filename = "Mobility_contact_Base.pdf", plot = combined_plot, width =29, height = 15)
# # Display the combined plot
# print(combined_plot)
# 
# ```
# # save data
# 
# ```{r load_data, echo = T}
# subtypes <- c("H1")
# skip <- 0
# row_names <- c("H1", "H2")
# df <- read.csv("assets/multistrain.csv",skip = skip, nrows = 707-skip, col.names = row_names)# WEEKLU
# NPI <- read.csv("assets/NPI.csv",skip = skip*7,nrows =6000-skip*7)# DAILY
# K=1;
# N = 1000000;
# Nweek <- nrow(df);
# vc <- numeric(5809)
# Vacc_Sea <- c(seq(45*7,57*7), seq(97*7,109*7), seq(144*7,156*7), seq(197*7,209*7), seq(254*7,266*7), seq(306*7,318*7), seq(357*7,369*7), seq(408*7,420*7), seq(459*7,471*7), seq(511*7,523*7), seq(564*7,576*7),seq(617*7,628*7),seq(669*7,680*7),seq(721*7,732*7),seq(773*7,787*7))
# for (day in 1:5809){
# if (day %in% Vacc_Sea) {
#     vc[day] <- 0.13/91
# }
# }
# vc <-  vc[(skip*7+1):5809]
# data_lst <- list(
#   SKIP = skip,
#   K = K, 
#   T = nrow(df)*7 + 1,
#   W = nrow(df),
#   N = N,
#   cases = df %>% dplyr::select(H1) %>%  +10^(-18) %>% as.matrix(),   #round() %>% 
#   vc = vc %>% as.array(),
#   NPI = NPI %>% as.matrix()
# )
# ```
# 
# ```{R}
# # install.packages(c("igraph", "ggplot2", "ggraph", "maps", "dplyr"))
# # g <- graph_from_adjacency_matrix(matrix(sum_move_infection1%>% t(), nrow=31, byrow=TRUE), mode="directed", weighted=TRUE)
# library(igraph)
# library(ggplot2)
# library(ggraph)
# library(maps)
# library(dplyr)

# 
# set.seed(123)
# V(g)$lon <- c(116.4142,117.323,114.9042,112.2922,113.9448,122.6085,126.1923,127.7615,121.4491,119.455,120.0934,117.2264,117.9874,115.7221,118.1498,113.614,112.2707,	111.7088,113.4244,108.7881,109.7453,107.874,102.7103,106.8748,101.487,88.0924,108.8701,104.2861,95.9956,106.1655,85.2401)
# V(g)$lat <- c(40.1824,39.3054,37.8957,37.5777,44.0935,41.2956,43.6661,47.862,31.202,32.9711,29.1832,31.8257,26.0789,27.614,36.3427,33.882,30.9756,27.6104,23.3417,23.8298,19.1959,30.0572,30.6171,26.8154,24.974,31.6927,35.1917,35.7518,35.7452,37.2692,41.1129)
# layout_matrix <- cbind(V(g)$lon, V(g)$lat)
# V(g)$weight <- data_lst$cases[5,]
# E(g)$eweight <- runif(ecount(g), 0.001, 0.005)
# V(g)$province <- c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongol', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Xizang', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
# library(rnaturalearth)
# library(rnaturalearthdata)
# china_province_map_data <- ne_states(country = "China", returnclass = "sf")
# taiwan_map_data <- ne_countries(country = "taiwan")
# common_columns <- intersect(colnames(china_province_map_data), colnames(taiwan_map_data))
# china_province_map_data <- china_province_map_data[, common_columns]
# taiwan_map_data <- taiwan_map_data[, common_columns]
# merged_map_data <- rbind(china_province_map_data, taiwan_map_data)
# # 使用Walktrap算法
# communities <- cluster_walktrap(g,weights = E(g)$weight,modularity = TRUE) #, modularity = 4
# # # 或者使用Spinglass算法
# # communities <- cluster_spinglass(g, spins = 25)
# V(g)$community <- communities$membership
# # 为每个省分配一个主社区（最多的节点数）
# province_communities <- data.frame(
#   province = V(g)$province,
#   community = V(g)$community)
# # V(g)$group <- paste(V(g)$community, V(g)$province, sep = "_")
# # # 根据group分配颜色
# # group_colors <- rainbow(length(unique(V(g)$group)))
# # names(group_colors) <- unique(V(g)$group)
# # V(g)$color <- group_colors[V(g)$group]
# # 统计每个省中社区的数量，并选择数量最多的社区作为主社区
# province_main_community <- aggregate(community ~ province, data = province_communities, 
#                                      FUN = function(x) as.numeric(names(sort(table(x), decreasing = TRUE)[1])))
# # 将省的社区信息加入到地图数据中
# merged_map_data$community <- province_main_community$community[match(merged_map_data$name, province_main_community$province)]
# # 为每个社区分配颜色
# community_colors <- rainbow(length(unique(merged_map_data$community)))
# names(community_colors) <- unique(merged_map_data$community)
# 绘图
# plot_combined <- ggraph(g, layout = layout_matrix) +
#   # 根据社区信息填充省份颜色
#   geom_sf(data = merged_map_data, aes(fill = as.factor(community)), color = "black", alpha = 0.3) +
#   scale_fill_manual(values = community_colors, name = "Communities") +
#   # 绘制网络的边，并添加箭头，使用 eweight 调整边的透明度和颜色
#   geom_edge_link(aes(width = eweight, alpha = eweight, color = eweight), arrow = arrow(length = unit(3, 'mm'), type = "open")) +
#   # 使用为社区分配的颜色绘制节点，并隐藏 color 图例
#   geom_node_point(aes(size = weight, color = as.factor(community))) +
#   # 调整图例和主题
#   scale_size_continuous(name = "Infection No") +
#   scale_edge_color_gradient(name = "Infection Move", low = "lightblue", high = "darkblue") +  # Adjust edge color gradient
#     scale_edge_width_continuous(name = "Link Weights", range = c(0.0001, 0.2)) +
#   scale_edge_alpha_continuous(name = "Link Transparency", range = c(0.0001, 0.2)) +  # Adjust transparency scaling
#   theme_void() +
#   guides(
#     fill = guide_legend(title = "Communities"),
#     size = guide_legend(title = "Infection No."),
#     edge_width ="none",
#     edge_alpha ="none",
#     color = "none"  # 隐藏 color 图例
#   )
# # 显示图形
# ggsave("plot_combined.pdf", plot_combined, width = 18, height = 12)
# plot_combined
# plot1 <- plot(communities, g)
# plot2 <-ggraph(g, layout = layout_matrix) +
#   # 绘制中国省级地图
#   geom_sf(data = merged_map_data, fill = "white", color = "black", alpha = 0.3) +
#   # 绘制网络的边，并添加箭头
#   geom_edge_link(aes(width =  eweight), color = "blue", alpha = 0.4,
#                  arrow = arrow(length = unit(3, 'mm'), type = "open")) +
#   # geom_edge_arc(aes(width = 0.01 * eweight), color = "blue", alpha = 0.6,
#   #                arrow = arrow(length = unit(3, 'mm'), type = "open")) +
#   # 绘制网络的节点
#   geom_node_point(aes(size = weight), color = "red") +
#   # 调整图例和主题
#   scale_size_continuous(name = "Node Weights") +
#   scale_edge_width_continuous(name = "Link Weights", range = c(0.000, 1)) +
#   theme_void()
# # 假设你有一个带有地理信息的节点数据框
# nodes_data <- data.frame(
#   id = V(g)$name,
#   community = membership(community),  # 社区划分信息
#   latitude = c(40.1824,39.3054,39.549,37.5777,44.0935,41.2956,43.6661,47.862,31.202,32.9711,29.1832,31.8257,26.0789,27.614,36.3427,37.8957,30.9756,27.6104,23.3417,23.8298,19.1959,30.0572,30.6171,26.8154,24.974,31.6927,35.1917,35.7518,35.7452,37.2692,41.1129),  # 示例经度
#   longitude = c(116.4142,117.323,116.1306,112.2922,113.9448,122.6085,126.1923,127.7615,121.4491,119.455,120.0934,117.2264,117.9874,115.7221,118.1498,114.9042,112.2707,	111.7088,113.4244,108.7881,109.7453,107.874,102.7103,106.8748,101.487,88.0924,108.8701,104.2861,95.9956,106.1655,85.2401)  # 示例纬度
# )
# 
# # 合并社区信息到节点数据
# nodes_data <- nodes_data %>%
#   mutate(community = factor(community))  # 转换为因子，以便后续映射颜色
```


```{R}
source("get_credible_intervals_data.r")
source("get_credible_intervals_data_whole.r")
row_names <-c('Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongolia', 'Liaoning', 'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui', 'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong', 'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan', 'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang')
# pred_ili_df_S1 <- get_credible_intervals_data(multistrain_fit$E_2,skip+365.25*5,row_names)
# pred_ili_df_V1 <- get_credible_intervals_data(multistrain_fit$V_2,skip+365.25*5,row_names)
# pred_ili_df_R1 <- get_credible_intervals_data(multistrain_fit$I_2,skip+365.25*5,row_names)
pred_ili_dfS <- get_credible_intervals_data(multistrain_fit$S,0+365.25*0,row_names)
# pred_ili_dfV <- get_credible_intervals_data(multistrain_fit$V,0+365.25*0,row_names)
pred_ili_dfR <- get_credible_intervals_data(multistrain_fit$R,0+365.25*0,row_names)
#save(list = ls(), file = "model_str_multi_AH_T_H_All_NB.Rdata")
```

```{R}
library(tidyverse)
library(ggpubr)
library(ggplot2)
#load("E:/Dong/one_drive/OneDrive - The University Of Hong Kong/model_str_multi_AH_T_H_All/model_str_multi_T_H_All_NB.Rdata")

plot2 <- ggplot() +
  geom_ribbon(data =pred_ili_dfS,aes(x = week,ymin = q025, ymax = q975), alpha = 0.1, fill = "red") +
  geom_ribbon(data =pred_ili_dfS,aes(x = week,ymin = q25, ymax = q75), alpha = 0.2, fill = "red") +
  geom_line(data =pred_ili_dfS,aes(x = week,y = q50), color = "red") +
  geom_ribbon(data =pred_ili_dfR,aes(x = week,ymin = q025, ymax = q975), alpha = 0.1, fill = "green") +
  geom_ribbon(data =pred_ili_dfR,aes(x = week,ymin = q25, ymax = q75), alpha = 0.2, fill = "green") +
  geom_line(data =pred_ili_dfR,aes(x = week,y = q50), color = "green") +
  facet_wrap(~ Subtype, ncol = 6, scales = "free_y", labeller = custom_labeller) +
  labs(
    x = "Time",
    y = "Proportion"
  ) +
    scale_x_continuous(breaks = seq(from = 0, to =  365.25*3+1, by = 365.25), labels = c("2020","2021","2022","2023"))+
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "bottom"
  )
# Display the plot
plot2
```

library(openxlsx)
wb <- createWorkbook()
for (i in 1:K) {
  # 提取每个表格的数据
  start_row <- (i - 1) * Nweek + 1
  end_row <- i * Nweek
  sub_data <- PILI[start_row:end_row, ]
  # 将数据添加到Excel工作簿的新Sheet中
  sheet_name <- paste("Sheet", i, sep = "")
  addWorksheet(wb, sheet_name)
  writeData(wb, sheet_name, sub_data)
}
saveWorkbook(wb, "outputlogn.xlsx", overwrite = TRUE)